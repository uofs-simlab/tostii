\documentclass{article}

\usepackage{amsfonts}
\usepackage{amsmath}

\newcommand{\bvec}[1]{\boldsymbol{#1}}
\newcommand{\brvec}[1]{\mathbf{#1}}
\newcommand{\bmat}[1]{\boldsymbol{#1}}
\newcommand{\brmat}[1]{\mathbf{#1}}
\newcommand{\ii}{\mathrm{i}}
\newcommand{\ee}{\mathrm{e}}
\newcommand{\dd}{\mathrm{d}}
\newcommand{\TT}{\mathrm{T}}

\begin{document}

\section{Introduction}

Let $\Omega \subseteq \mathbb{R}^n$,
$V : \Omega \rightarrow \mathbb{R}$,
$\kappa \in \mathbb{R}$,
and $\psi : (0, T) \times \Omega \rightarrow \mathbb{C}$.
The Nonlinear Schroedinger Equation (NSE) is given by:
\begin{align*}
-\ii \frac{\partial \psi}{\partial t} - \frac{1}{2} \Delta \psi + V \psi + \kappa |\psi|^2 \psi = 0
\end{align*}
\noindent With initial conditions:
\begin{align*}
\psi(0, \bvec{x}) = \psi_0(\bvec{x})
\end{align*}
\noindent For all $\bvec{x} \in \Omega$ and with boundary conditions:
\begin{align*}
\psi(t, \bvec{x}) = 0
\end{align*}
\noindent For all $(t, \bvec{x}) \in (0, T) \times \partial \Omega$.

Because $\psi$ is complex-valued, it is convenient to separate the equation into real and imaginary parts.
If we take $\psi(t, \bvec{x}) = u(t, \bvec{x}) + \ii v(t, \bvec{x})$
for $u, v : (0, T) \times \Omega \rightarrow \mathbb{R}$,
we also have that $|\psi|^2 = u^2 + v^2$:
\begin{align*}
    -\ii \frac{\partial}{\partial t} (u + \ii v) - \frac{1}{2} \Delta (u + \ii v)
            + V (u + \ii v) + \kappa (u^2 + v^2) (u + \ii v)
        = 0
\end{align*}
\noindent So:
\begin{align*}
    \frac{\partial v}{\partial t} - \frac{1}{2} \Delta u + V u + \kappa (u^2 + v^2) u & = 0 \\
    -\frac{\partial u}{\partial t} - \frac{1}{2} \Delta v + V v + \kappa (u^2 + v^2) v & = 0
\end{align*}

\newpage

\section{Toy Problem}

Let $\Omega = [-1, 1]^n$, and consider, for an example:
\begin{align*}
    u(t, \bvec{x}) & = \cos(\pi t) \prod_{i = 1}^n \cos(\pi x_i) \\
    v(t, \bvec{x}) & = \sin(\pi t) \prod_{i = 1}^n \cos(\pi x_i)
\end{align*}
\noindent Then:
\begin{align*}
    u(0, \bvec{x}) & = \prod_{i = 1}^n \cos(\pi x_i) \\
    v(0, \bvec{x}) & = 0
\end{align*}

We have that:
\begin{align*}
    u^2 + v^2
        & = \cos^2(\pi t) \prod_{i = 1}^n \cos^2(\pi x_i)
            + \sin^2(\pi t) \prod_{i = 1}^n \cos^2(\pi x_i) \\
        & = (\cos^2(\pi t) + \sin^2(\pi t)) \prod_{i = 1}^n \cos^2(\pi x_i) \\
        & = \prod_{i = 1}^n \cos^2(\pi x_i)
\end{align*}
\noindent Note that $u^2 + v^2$ is independent of $t$. So:

Meanwhile:
\begin{align*}
    \frac{\partial u}{\partial x_k} & = -\pi \cos(\pi t) \sin(\pi x_k) \prod_{i \neq k} \cos(\pi x_i) \\
    \frac{\partial^2 u}{\partial x_k^2} & = -\pi^2 \cos(\pi t) \prod_{i = 1}^n \cos(\pi x_i) \\
        & = -\pi^2 u \\
    \Delta u & = \sum_{k = 1}^n \frac{\partial^2 u}{\partial x_k^2} \\
        & = -n \pi^2 u
\end{align*}
\noindent Similarly:
\begin{align*}
    \Delta v = -n \pi^2 v
\end{align*}
\noindent And:
\begin{align*}
    \frac{\partial u}{\partial t} & = -\pi \sin(\pi t) \prod_{i = 1}^n \cos(\pi x_i) \\
        & = -\pi v \\
    \frac{\partial v}{\partial t} & = \pi \cos(\pi t) \prod_{i = 1}^n \cos(\pi x_i) \\
        & = \pi u
\end{align*}

Then, rewriting the first equation:
\begin{align*}
    V u & = -\frac{\partial v}{\partial t} + \frac{1}{2} \Delta u - \kappa (u^2 + v^2) u \\
        & = -\pi u - \frac{n}{2} \pi^2 u - \kappa (u^2 + v^2) u \\
    V(\bvec{x}) & = -\pi - \frac{n}{2} \pi^2 - \kappa (u^2 + v^2)
\end{align*}
\noindent And the second equation:
\begin{align*}
    V v & = \frac{\partial u}{\partial t} + \frac{1}{2} \Delta v - \kappa (u^2 + v^2) v \\
        & = -\pi v - \frac{n}{2} \pi^2 v - \kappa (u^2 + v^2) v \\
    V(\bvec{x}) & = -\pi - \frac{n}{2} \pi^2 - \kappa (u^2 + v^2)
\end{align*}
\noindent We see that the equations agree.

\newpage

\section{Spatial Discretization}

Consider a set of basis function $\bvec{\Phi}_i : \Omega \rightarrow \mathbb{R}^2$,
where each $\bvec{\Phi}_i(\bvec{x}) = \varphi_{b_i} \hat{\brvec{e}}_{c_i}$,
where $\varphi_j : \Omega \rightarrow \mathbb{R}$ is a set of basis functions
($b_i$ is the base index of the index $i$ and $c_i$ is the component index of $i$).
We write $\bvec{w} = \begin{bmatrix}
    u \\
    v
\end{bmatrix}$ and make the approximation $\bvec{w} = W_j \bvec{\Phi}_j$ (Einstein summation);
furthermore, we approximate $\frac{\partial \bvec{w}}{\partial t} = \dot{W}_j \bvec{\Phi}_j$.
Then, we have that:
\begin{align*}
    u & = W_j \varphi_{b_j} \delta_{1, c_j} \\
    v & = W_j \varphi_{b_j} \delta_{2, c_j} \\
    \frac{\partial u}{\partial t} & = \dot{W}_j \varphi_{b_j} \delta_{1, c_j} \\
    \frac{\partial v}{\partial t} & = \dot{W}_j \varphi_{b_j} \delta_{2, c_j}
\end{align*}

Then, we multiply and integrate the system with a basis function $\bvec{\Phi}_i$:
\begin{align*}
    \left< \bvec{\Phi}_i \mid \begin{matrix}
            \partial_t v - \frac{1}{2} \Delta u + V u + \kappa (u^2 + v^2) u \\
            -\partial_t u - \frac{1}{2} \Delta v + V v + \kappa (u^2 + v^2) v
        \end{matrix} \right> & = 0 \\
    \ii \left< \bvec{\Phi}_i \mid \begin{matrix}
            \partial_t v \\
            -\partial_t u
        \end{matrix} \right> - \frac{1}{2} \left< \bvec{\Phi}_i \mid \begin{matrix}
            \Delta u \\
            \Delta v
        \end{matrix} \right> + \left< \bvec{\Phi}_i \mid \begin{matrix}
            V u \\
            V v
        \end{matrix} \right> + \kappa \left< \bvec{\Phi}_i \mid \begin{matrix}
            u^3 \\
            v^3
        \end{matrix} \right> + \kappa \left< \bvec{\Phi}_i \mid \begin{matrix}
            u v^2 \\
            u^2 v
        \end{matrix} \right> & = 0
\end{align*}
\noindent We consider each form separately:
\begin{align*}
    \left< \bvec{\Phi}_i \mid \begin{matrix}
        \partial_t v \\
        -\partial_t u
    \end{matrix} \right>
    & = \delta_{1, c_i} \left< \varphi_{b_i} \mid \partial_t v \right>
        - \delta_{2, c_i} \left< \varphi_{b_i} \mid \partial_t u \right> \\
    & = \delta_{1, c_i} \left< \varphi_{b_i} \mid \dot{W}_j \varphi_{b_j} \delta_{2, c_j} \right>
        - \delta_{2, c_i} \left< \varphi_{b_i} \mid \dot{W}_j \varphi_{b_j} \delta_{1, c_j} \right> \\
    & = (\delta_{1, c_i} \delta_{2, c_j} - \delta_{2, c_i} \delta_{1, c_j})
        \left< \varphi_{b_i} \mid \varphi_{b_j} \right> \dot{W}_j
\end{align*}
\begin{align*}
    \left< \bvec{\Phi}_i \mid \begin{matrix}
        \Delta u \\
        \Delta v
    \end{matrix} \right>
    & = \delta_{1, c_i} \left< \varphi_{b_i} \mid \Delta u \right>
        + \delta_{2, c_i} \left< \varphi_{b_i} \mid \Delta v \right>
\end{align*}
\noindent We note that:
\begin{align*}
    \left< \varphi_{b_i} \mid \Delta f \right>
    & = \int_\Omega \varphi_{b_i} \Delta f \, \dd \bvec{x} \\
    & = \oint_{\partial \Omega} \varphi_{b_i} \nabla f \cdot \hat{\brvec{n}} \, \dd \bvec{s}
        - \int_\Omega \nabla \varphi_{b_i} \cdot \nabla f \, \dd \bvec{x} \\
    & = \left< \varphi_{b_i} \hat{\brvec{n}} \mid \nabla f \right>_{\partial \Omega}
        - \left< \nabla \varphi_{b_i} \mid \nabla f \right>
\end{align*}
\noindent And, because we have Dirichlet boundary conditions,
we must have that $\varphi_{b_i}(t, \bvec{x}) = 0$
for all $(t, \bvec{x}) \in (0, T) \times \partial \Omega$. So:
\begin{align*}
    \left< \bvec{\Phi}_i \mid \begin{matrix}
        \Delta u \\
        \Delta v
    \end{matrix} \right>
    & = -\delta_{1, c_i} \left< \nabla \varphi_{b_i} \mid \nabla u \right>
        - \delta_{2, c_i} \left< \nabla \varphi_{b_i} \mid \nabla v \right> \\
    & = -\delta_{1, c_i} \left< \nabla \varphi_{b_i} \mid W_j \nabla \varphi_{b_j} \delta_{1, c_j} \right>
        - \delta_{2, c_i} \left< \nabla \varphi_{b_i} \mid W_j \nabla \varphi_{b_j} \delta_{2, c_j} \right> \\
    & = -(\delta_{1, c_i} \delta_{1, c_j} + \delta_{2, c_i} \delta_{2, c_j})
        \left< \nabla \varphi_{b_i} \mid \nabla \varphi_{b_j} \right> W_j
\end{align*}
\begin{align*}
    \left< \bvec{\Phi}_i \mid \begin{matrix}
        V u \\
        V v
    \end{matrix} \right>
    & = \delta_{1, c_i} \left< \varphi_{b_i} \mid V u \right>
        + \delta{2, c_i} \left< \varphi_{b_i} \mid V v \right> \\
    & = \delta_{1, c_i} \left< \varphi_{b_i} \mid W_j V \varphi_{b_j} \delta_{1, c_j} \right>
        + \delta_{2, c_i} \left< \varphi_{b_i} \mid W_j V \varphi_{b_j} \delta_{2, c_j} \right> \\
    & = (\delta_{1, c_i} \delta_{1, c_j} + \delta_{2, c_i} \delta_{2, c_j})
        \left< \varphi_{b_i} \mid V \varphi_{b_j} \right> W_j
\end{align*}
\noindent We will not use the fact that $\bvec{w} = W_j \bvec{\Phi}_j$
in considering the nonlinear forms at this time.

So:
\begin{align*}
    0 & = (\delta_{1, c_i} \delta_{2, c_j} - \delta_{2, c_i} \delta_{1, c_j})
            \left< \varphi_{b_i} \mid \varphi_{b_j} \right> \dot{W}_j \\
        & \qquad + \frac{1}{2} (\delta_{1, c_i} \delta_{1, c_j} + \delta_{2, c_i} \delta_{2, c_j})
            \left< \nabla \varphi_{b_i} \mid \nabla \varphi_{b_j} \right> W_j \\
        & \qquad + (\delta_{1, c_i} \delta_{1, c_j} + \delta_{2, c_i} \delta_{2, c_j})
            \left< \varphi_{b_i} \mid V \varphi_{b_j} \right> W_j \\
        & \qquad + \kappa \delta_{1, c_i} \left< \varphi_{b_i} \mid u^3 + u v^2 \right> \\
        & \qquad + \kappa \delta_{2, c_i} \left< \varphi_{b_i} \mid v^3 + u^2 v \right>
\end{align*}
\noindent If we define:
\begin{align*}
    M_{ij} & = (\delta_{1, c_i} \delta_{2, c_j} - \delta_{2, c_i} \delta_{1, c_j})
        \left< \varphi_{b_i} \mid \varphi_{b_j} \right> \\
    A_{ij} & = \frac{1}{2} (\delta_{1, c_i} \delta_{1, c_j} + \delta_{2, c_i} \delta_{2, c_j})
        \left< \nabla \varphi_{b_i} \mid \nabla \varphi_{b_j} \right> \\
    B_{ij} & = (\delta_{1, c_i} \delta_{1, c_j} + \delta_{2, c_i} \delta_{2, c_j})
        \left< \varphi_{b_i} \mid V \varphi_{b_j} \right> \\
    C_i & = \kappa \delta_{1, c_i} \left< \varphi_{b_i} \mid u^3 + u v^2 \right>
        + \kappa \delta_{2, c_i} \left< \varphi_{b_i} \mid v^3 + u^2 v \right>
\end{align*}
\noindent We rewrite the above equation as:
\begin{align*}
    \brvec{0} & = \bvec{M} \dot{\bvec{W}}
        + (\bmat{A} + \bmat{B}) \bvec{W}
        + \bvec{C}
\end{align*}

\newpage

\section{Time Stepping}

In order to solve the monolithic system using an implicit Runge-Kutta method,
we rewrite the equation from previous section:
\begin{align*}
    \bmat{M} \dot{\bvec{W}}
        & = -(\bmat{A} + \bmat{B}) \bvec{W}
            - \bvec{C} \\
    \dot{\bvec{W}}
        & = -\bmat{M}^{-1} (\bmat{A} + \bmat{B}) \bvec{W}
            - \bmat{M}^{-1} \bvec{C} \\
        & = \bvec{F}(\bvec{W})
\end{align*}
\noindent We must compute the action of
$(\brmat{I} - \tau \brmat{J}[\bvec{F}])^{-1}$
on a vector. We have that:
\begin{align*}
    \brmat{J}[\bvec{F}]
        & = \frac{\partial \bvec{F}}{\partial \bvec{W}} \\
        & = -\frac{\partial}{\partial \bvec{W}}
                (\bmat{M}^{-1} (\bmat{A} + \bmat{B}) \bvec{W})
            - \frac{\partial}{\partial \bvec{W}}
                (\bmat{M}^{-1} \bvec{C}) \\
        & = -\bmat{M}^{-1} (\bmat{A} + \bmat{B})
            - \bmat{M}^{-1} \brmat{J}[\bvec{C}]
\end{align*}

So, we must determine $\brmat{J}[\bvec{C}]$:
\begin{align*}
    \frac{\partial C_i}{\partial W_j}
        & = \frac{\partial}{\partial W_j}
            (\kappa \delta_{1, c_i} \left< \varphi_{b_i} \mid u^3 + u v^2 \right>
                + \kappa \delta_{2, c_i} \left< \varphi_{b_i} \mid v^3 + u^2 v \right>)
\end{align*}
\noindent So, consider:
\begin{align*}
    \frac{\partial}{\partial W_k} \left< \varphi_{b_i} \mid u^3 \right>
        & = \frac{\partial}{\partial W_k}
            \left< \varphi_{b_i} \mid (W_j \varphi_{b_j} \delta_{1, c_j})^3 \right> \\
        & = \left< \varphi_{b_i} \mid \frac{\partial}{\partial W_k} (W_j \varphi_{b_j} \delta_{1, c_j})^3 \right>
\end{align*}
\noindent What is the coefficient of $W_k$ in $(W_j \varphi_{b_j} \delta_{1, c_j})^3$?
First, note that:
\begin{align*}
    (W_j \varphi_{b_j} \delta_{1, c_j})^3
        & = (W_{j_1} \varphi_{b_{j_1}} \delta_{1, c_{j_1}})
            (W_{j_2} \varphi_{b_{j_2}} \delta_{1, c_{j_2}})
            (W_{j_3} \varphi_{b_{j_3}} \delta_{1, c_{j_3}}) \\
        & = W_{j_1} W_{j_2} W_{j_3}
            \varphi_{b_{j_1}} \varphi_{b_{j_2}} \varphi_{b_{j_3}}
            \delta_{1, c_{j_1}} \delta_{1, c_{j_2}} \delta_{1, c_{j_3}}
\end{align*}

\end{document}
